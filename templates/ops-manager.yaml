{{- if .Values.opsManager.enabled }}
---
apiVersion: mongodb.com/v1
kind: MongoDBOpsManager
metadata:
  name: {{ .Release.Name }}-ops-manager
  namespace: {{ .Release.Namespace }}
  labels:
    app: mongodb-ops-manager
    product: {{ .Chart.Name }}
spec:
  replicas: 1
  version: 4.2.12
  adminCredentials: {{ .Release.Name }}-ops-manager-secret
  externalConnectivity:
    type: LoadBalancer
  applicationDatabase:
    members: 3
    version: 4.2.2-ent
    persistent: true
#  podSpec:
#    podTemplate:
#      spec:
        # This container will be added to each pod as a sidecar
#        containers:
#          - name: smtp-sidecar
#            image: bytemark/smtp
#          - name: {{ .Release.Name }}-ops-manager
#            env:
#           - name: SKIP_OPS_MANAGER_REGISTRATION
#             value: "true"
{{- if .Values.opsManager.nodeAffinity }}
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: kubernetes.io/role
              operator: In
              values:
              - {{ .Values.opsManager.nodeAffinity.nodeRole }}
{{- end }}

{{- if eq .Values.opsManager.backup.enabled true }}
  backup:
    enabled: true
    opLogStores:
    - name: oplog1
      mongodbResourceRef:
        name: {{ .Release.Name }}-ops-manager-backup
    s3Stores:
    - name: S3GatewayStore1
      mongodbResourceRef:
        name: ops-manager-backup
      pathStyleAccessEnabled: true
      s3BucketEndpoint: http://minio:9000
      s3BucketName: test
      s3SecretRef:
        name: minio
# {{- else  }}
#   backup:
#     enabled: false
{{- end }}

#{{ .Values.opsManager.nodeAffinity }}
{{- if .Values.opsManager.nodeAffinity }}
    podSpec:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/role
                operator: In
                values:
                - {{ .Values.opsManager.nodeAffinity.nodeRole }}-backup-daemon
{{- end }}

{{- if .Values.opsManager.nodeAffinity }}
    podSpec:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/role
                operator: In
                values:
                - {{ .Values.opsManager.nodeAffinity.nodeRole }}
{{- end }}
{{- end }}
